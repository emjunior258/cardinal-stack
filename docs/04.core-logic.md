# Core Logic
This section describes the core functional logic implemented by the platform, allowing a clear understanding of how the platform functions.

## USSD code Request

A USSD Code request starts when a user dials a code on their mobile device.

As the USSD Code request comes from a Mobile Network Operator (MNO) USSD Gateway into the platform, it checks whether the request is valid and then checks which application Entry point is mapped to the short code. If there is no mapped application entry point, it outputs a Entry point not found message.

If there is a mapped application entry point but there is an active suspension, then the defined suspension message is returned.

If there is no active suspension and there is a short list bound to the entry point, then the platform checks whether the requester MSISDN is in the short list. If the MSISDN is not in the short list then it outputs the exclusion message.

If there is no active suspension and there is no short list bound to the entry point or if the requester MSISDN is in the short list, then the platform initializes session and then proceeds with Backend dispatching.


### Session initialization

Session initialization is about creating a new session for a USSD request. It involves setting up the initial state of the session, including the session ID, the request ID, and the request parameters.

The initialization of a session involves setting session values that have been predefined on the Entry-point level.


### Backend dispatching
Backend dispatching is about interacting with a USSD Application backend to process a USSD Request.

The platform first checks if it has a valid Application map in its cache. If it does not, it attempts to fetch the Appication map from the backend, by issuing a request to the backend.

If the Application map is successfully fetched and cached, the platform proceeds with Backend processing.

If the Application map cannot be fetched or cached, the platform outputs the internal error message.

Assuming that Application Map is available in the cache, the platform sends an "Execute Request" to the backend, including only the context values listed for the initial activity.

The Backend is expected to respond with:

* The screen content to be displayed
* The session values to be updated (optional)
* A Input Traps Map (optional)

Once backend responds the platform proceeds with session value changes then persists the Input Traps Map in the session context. Lastly the platform sends the screen Content to be displayed.

## Screen/App navigation flow
The navigation on a USSD application flows from one activity to the other according to 2 things:

* User input
* Backend response

The Initial short code dialing triggers the main activity and from that point it's up to the Backend.

The Backend is expected to respond to each Request with a mapping that defines the possible next activities (Id of each activity), depending on the user input, where there is a regular expression that matches the user input. This mapping is denoted as Input Traps Map.

The Map contains an entry with empty regulator expression, which is used to define the default activity to be executed when no other entry matches the user input.

If the Backend doesn't respond with an Input Traps Map, the platform assumes that the content returned is a terminal content and it terminates the session.

## USSD Redirection
A USSD Redirect is a mechanism that allows a user to be redirected from current journey/flow to another.
The platform allows redirect to Internal destinations (Application Entry points) or External ones (Known by the USSD Gateway).

The Redirect is triggered by the Backend response, which includes the destination to redirect the user to.

The Backend responds with HTTP 307, with location header containing the destination.

### Redirecting within the platform
Redirecting within the platform is achieved by sending a HTTP 307 response with the location header containing the destination entry point id.
```
HTTP/1.1 307 Temporary Redirect
Location: /internal/{destination-entry-point-id}
```

### Redirecting to external Application
A redirect to an external application requires the short code of the application.
```
HTTP/1.1 307 Temporary Redirect
Location: /external/{short-code}
```

## Mobile Network Integration
Yet to be documented

## Simulations
Yet to be documented
